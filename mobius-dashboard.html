<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobius Test Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<div id="app" class="max-w-6xl mx-auto">
<!-- Header -->
<div class="mb-6">
<h1 class="text-2xl font-bold text-gray-800">üîÑ Mobius Test Dashboard</h1>
<p class="text-gray-600">Brand Governance Engine - Testing Interface</p>
</div>

<!-- API Config -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
<h3 class="font-semibold mb-3">API Configuration</h3>
<div class="flex gap-2">
<input type="text" id="apiUrl" placeholder="https://rocoloco--mobius-v2-fastapi-app.modal.run/v1"
value="https://rocoloco--mobius-v2-fastapi-app.modal.run/v1"
class="flex-1 border rounded px-3 py-2 text-sm">
<button onclick="checkHealth()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Connect</button>
</div>
<div id="healthStatus" class="mt-2 text-sm"></div>
</div>

<!-- Tabs -->
<div class="flex gap-2 mb-4">
<button onclick="showTab('brands')" id="tab-brands" class="px-4 py-2 font-medium rounded-t-lg bg-white text-blue-600 border-b-2 border-blue-600">üìÅ Brands</button>
<button onclick="showTab('generate')" id="tab-generate" class="px-4 py-2 font-medium rounded-t-lg bg-gray-100 text-gray-600 hover:bg-gray-200">üé® Generate</button>
<button onclick="showTab('gallery')" id="tab-gallery" class="px-4 py-2 font-medium rounded-t-lg bg-gray-100 text-gray-600 hover:bg-gray-200">üñºÔ∏è Gallery (<span id="assetCount">0</span>)</button>
</div>

<!-- Tab Content -->
<div class="bg-gray-50 rounded-lg p-4">
<!-- Brands Tab -->
<div id="content-brands" class="grid md:grid-cols-2 gap-4">
<!-- Upload -->
<div class="space-y-4">
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Upload Brand Guidelines</h3>

<!-- PDF Upload -->
<div class="mb-3">
<label class="block text-sm text-gray-600 mb-1">Brand Guidelines PDF *</label>
<div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
<input type="file" id="pdfFile" accept=".pdf" class="hidden" onchange="updateFileName()">
<label for="pdfFile" class="cursor-pointer text-blue-600 hover:text-blue-800" id="fileLabel">
<svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
</svg>
Click to select PDF (max 50MB)
</label>
</div>
</div>

<!-- Logo Upload -->
<div class="mb-3">
<label class="block text-sm text-gray-600 mb-1">
Brand Logo (Optional)
<span class="text-xs text-green-600 font-medium">- SVG preferred for best quality!</span>
</label>
<div class="border-2 border-dashed border-blue-200 rounded-lg p-4 text-center bg-blue-50">
<input type="file" id="logoFile" accept=".svg,.png,.jpg,.jpeg" class="hidden" onchange="updateLogoFileName()">
<label for="logoFile" class="cursor-pointer text-blue-600 hover:text-blue-800" id="logoLabel">
<svg class="w-8 h-8 mx-auto mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
</svg>
Upload logo for best results
</label>
<p class="text-xs text-gray-500 mt-1">SVG (vector) preferred, or PNG with transparency (max 10MB)</p>
</div>
</div>

<button onclick="uploadBrand()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 disabled:opacity-50 font-medium" id="uploadBtn">Upload & Ingest</button>
<div id="uploadStatus" class="mt-3"></div>
</div>

<!-- Brand List -->
<div class="bg-white rounded-lg shadow p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="font-semibold">Brands (<span id="brandCount">0</span>)</h3>
<button onclick="fetchBrands()" class="text-blue-600 hover:text-blue-800 text-sm">‚Üª Refresh</button>
</div>
<div id="brandList" class="space-y-2 max-h-64 overflow-y-auto">
<p class="text-gray-500 text-sm">No brands yet. Upload a PDF above.</p>
</div>
</div>
</div>

<!-- Brand Details -->
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Brand Details</h3>
<div id="brandDetails" class="text-gray-500 text-center">Select a brand to view details</div>
</div>
</div>

<!-- Generate Tab -->
<div id="content-generate" class="hidden grid md:grid-cols-2 gap-4">
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Generate Asset</h3>
<div class="space-y-3">
<div>
<label class="block text-sm text-gray-600 mb-1">Brand</label>
<select id="brandSelect" class="w-full border rounded px-3 py-2">
<option value="">Select a brand...</option>
</select>
</div>
<div>
<label class="block text-sm text-gray-600 mb-1">Prompt</label>
<textarea id="promptInput" placeholder="Describe the asset you want to generate...
Example: A social media banner featuring our product with bold typography"
class="w-full border rounded px-3 py-2 h-28 resize-none"></textarea>
</div>
<button onclick="generateAsset()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 font-medium" id="generateBtn">üé® Generate Asset</button>
<div id="jobStatus"></div>
<div id="generateError"></div>
</div>
</div>

<!-- Result -->
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Generated Asset</h3>
<div id="assetResult" class="text-gray-500 text-center">Generated assets will appear here</div>
</div>
</div>

<!-- Gallery Tab -->
<div id="content-gallery" class="hidden">
<div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500 col-span-full">
<p class="text-lg mb-2">No assets generated yet</p>
<p class="text-sm">Use the Generate tab to create some!</p>
</div>
</div>
</div>
</div>

<!-- Footer -->
<div class="mt-6 text-center text-sm text-gray-400">Mobius Brand Governance Engine ‚Ä¢ Phase 2 Testing</div>
</div>

<script>
// State
let apiBase = '';
let brands = [];
let assets = [];
let selectedBrand = null;

// Tab switching
function showTab(tab) {
['brands', 'generate', 'gallery'].forEach(t => {
document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
document.getElementById(`tab-${t}`).classList.toggle('bg-white', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('text-blue-600', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('border-b-2', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('border-blue-600', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('bg-gray-100', t !== tab);
document.getElementById(`tab-${t}`).classList.toggle('text-gray-600', t !== tab);
});
}

// Health check
async function checkHealth() {
apiBase = document.getElementById('apiUrl').value.trim();
const statusDiv = document.getElementById('healthStatus');
statusDiv.innerHTML = '<span class="text-blue-600">Checking...</span>';
try {
const response = await fetch(`${apiBase}/health`);
const data = await response.json();
if (response.ok) {
statusDiv.innerHTML = '<span class="text-green-600">‚úì Connected to Mobius API</span>';
fetchBrands();
} else {
statusDiv.innerHTML = `<span class="text-red-600">‚úó ${data.detail || 'API Error'}</span>`;
}
} catch (e) {
statusDiv.innerHTML = `<span class="text-red-600">‚úó Connection failed: ${e.message}</span>`;
}
}

// Fetch brands
async function fetchBrands() {
if (!apiBase) return;
try {
const response = await fetch(`${apiBase}/brands?organization_id=00000000-0000-0000-0000-000000000000`);
const data = await response.json();
brands = data.brands || data || [];
document.getElementById('brandCount').textContent = brands.length;
renderBrandList();
updateBrandSelect();
} catch (e) {
console.error('Failed to fetch brands:', e);
}
}

// Render brand list
function renderBrandList() {
const container = document.getElementById('brandList');
if (brands.length === 0) {
container.innerHTML = '<p class="text-gray-500 text-sm">No brands yet. Upload a PDF above.</p>';
return;
}
container.innerHTML = brands.map(brand => `
<div onclick="selectBrand('${brand.brand_id}')" class="p-3 rounded cursor-pointer transition-colors ${selectedBrand?.brand_id === brand.brand_id ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50 hover:bg-gray-100'}">
<div class="flex justify-between items-start">
<div>
<p class="font-medium">${brand.name || 'Unnamed Brand'}</p>
<p class="text-xs text-gray-500 font-mono">${brand.brand_id?.slice(0, 8)}...</p>
</div>
${brand.learning_active ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Learning</span>' : ''}
</div>
</div>
`).join('');
}

// Select brand
async function selectBrand(brandId) {
try {
const response = await fetch(`${apiBase}/brands/${brandId}`);
selectedBrand = await response.json();
renderBrandList();
renderBrandDetails();
} catch (e) {
console.error('Failed to fetch brand details:', e);
}
}

// Render brand details
function renderBrandDetails() {
const container = document.getElementById('brandDetails');
if (!selectedBrand) {
container.innerHTML = '<p class="text-gray-500 text-center">Select a brand to view details</p>';
return;
}

const guidelines = selectedBrand.guidelines || {};
const colors = guidelines.colors || [];
const typography = guidelines.typography || [];
const logos = guidelines.logos || [];
const voice = guidelines.voice || null;
const rules = guidelines.rules || [];

container.innerHTML = `
<div class="space-y-4 max-h-[600px] overflow-y-auto">
${selectedBrand.logo_thumbnail_url ? `
<div class="flex justify-center p-4 bg-gray-50 rounded">
<img src="${selectedBrand.logo_thumbnail_url}" alt="${selectedBrand.name} logo" class="max-h-24 object-contain">
</div>
` : ''}

<div>
<p class="text-xs text-gray-500 uppercase tracking-wide">Name</p>
<p class="font-medium">${selectedBrand.name || 'Unnamed'}</p>
</div>

<div>
<p class="text-xs text-gray-500 uppercase tracking-wide">ID</p>
<p class="text-sm font-mono bg-gray-100 p-1 rounded">${selectedBrand.brand_id}</p>
</div>

${selectedBrand.pdf_url ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Brand Guidelines PDF</p>
<a href="${selectedBrand.pdf_url}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
View Original PDF
</a>
</div>
` : ''}

${colors.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Colors (${colors.length})</p>
<div class="space-y-2">
${colors.map(color => `
<div class="flex items-start gap-2">
<div class="w-10 h-10 rounded border shadow-sm flex-shrink-0" style="background-color: ${color.hex}" title="${color.hex}"></div>
<div class="flex-1 min-w-0">
<p class="text-sm font-medium">${color.name}</p>
<p class="text-xs text-gray-500">${color.hex} ‚Ä¢ ${color.usage}</p>
${color.context ? `<p class="text-xs text-gray-600 mt-1">${color.context}</p>` : ''}
</div>
</div>
`).join('')}
</div>
</div>
` : ''}

${typography.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Typography (${typography.length})</p>
<div class="space-y-2">
${typography.map(typo => `
<div class="bg-gray-50 p-2 rounded">
<p class="text-sm font-medium">${typo.family}</p>
<p class="text-xs text-gray-500">Weights: ${typo.weights.join(', ')}</p>
<p class="text-xs text-gray-600 mt-1">${typo.usage}</p>
</div>
`).join('')}
</div>
</div>
` : ''}

${logos.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Logo Rules (${logos.length})</p>
<div class="space-y-2">
${logos.map(logo => `
<div class="bg-gray-50 p-2 rounded">
<p class="text-sm font-medium">${logo.variant_name}</p>
<p class="text-xs text-gray-600">Min width: ${logo.min_width_px}px</p>
<p class="text-xs text-gray-600">Clear space: ${(logo.clear_space_ratio * 100).toFixed(0)}%</p>
${logo.forbidden_backgrounds.length > 0 ? `<p class="text-xs text-red-600 mt-1">Avoid: ${logo.forbidden_backgrounds.join(', ')}</p>` : ''}
</div>
`).join('')}
</div>
</div>
` : ''}

${voice ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Voice & Tone</p>
<div class="bg-gray-50 p-2 rounded space-y-2">
${voice.adjectives?.length > 0 ? `<p class="text-xs"><span class="font-medium">Adjectives:</span> ${voice.adjectives.join(', ')}</p>` : ''}
${voice.forbidden_words?.length > 0 ? `<p class="text-xs text-red-600"><span class="font-medium">Avoid:</span> ${voice.forbidden_words.join(', ')}</p>` : ''}
${voice.example_phrases?.length > 0 ? `
<div class="text-xs">
<p class="font-medium">Examples:</p>
<ul class="list-disc list-inside mt-1">
${voice.example_phrases.map(phrase => `<li>${phrase}</li>`).join('')}
</ul>
</div>
` : ''}
</div>
</div>
` : ''}

${rules.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Brand Rules (${rules.length})</p>
<div class="space-y-2">
${rules.map(rule => `
<div class="bg-gray-50 p-2 rounded border-l-2 ${rule.severity === 'critical' ? 'border-red-500' : 'border-yellow-500'}">
<div class="flex items-start justify-between gap-2">
<p class="text-xs flex-1">${rule.instruction}</p>
<span class="text-xs px-1.5 py-0.5 rounded ${rule.severity === 'critical' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${rule.severity}</span>
</div>
<p class="text-xs text-gray-500 mt-1">${rule.category} ${rule.negative_constraint ? '‚Ä¢ Do Not' : ''}</p>
</div>
`).join('')}
</div>
</div>
` : ''}

${selectedBrand.needs_review?.length > 0 ? `
<div class="p-3 bg-yellow-50 rounded border border-yellow-200">
<p class="text-xs text-yellow-700 uppercase tracking-wide font-medium">Needs Review</p>
<ul class="text-sm text-yellow-800 mt-1">
${selectedBrand.needs_review.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
</ul>
</div>
` : ''}

<details class="text-sm">
<summary class="cursor-pointer text-gray-500 hover:text-gray-700">‚ñº View Raw Guidelines JSON</summary>
<pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-48">${JSON.stringify(guidelines, null, 2)}</pre>
</details>
</div>
`;
}

// Update brand select dropdown
function updateBrandSelect() {
const select = document.getElementById('brandSelect');
select.innerHTML = '<option value="">Select a brand...</option>' + 
brands.map(b => `<option value="${b.brand_id}">${b.name || b.brand_id?.slice(0, 8)}</option>`).join('');
}

// File upload helpers
function updateFileName() {
const file = document.getElementById('pdfFile').files[0];
const label = document.getElementById('fileLabel');
if (file) {
label.innerHTML = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${file.name}`;
} else {
label.innerHTML = `<svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Click to select PDF (max 50MB)`;
}
}

function updateLogoFileName() {
const file = document.getElementById('logoFile').files[0];
const label = document.getElementById('logoLabel');
if (file) {
const fileName = file.name.toLowerCase();
const isSVG = fileName.endsWith('.svg');
const isPNG = fileName.endsWith('.png');
const isJPG = fileName.endsWith('.jpg') || fileName.endsWith('.jpeg');

let icon, message;
if (isSVG) {
// SVG is best - green checkmark with star
icon = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = ' <span class="text-xs text-green-600 font-medium">‚ú® Perfect! Vector format</span>';
} else if (isPNG) {
// PNG is good - green checkmark
icon = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = ' <span class="text-xs text-gray-500">(SVG would be even better)</span>';
} else if (isJPG) {
// JPG is okay but not ideal - yellow warning
icon = `<svg class="w-6 h-6 inline mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
message = ' <span class="text-xs text-yellow-600">(PNG or SVG preferred)</span>';
} else {
// Unknown format
icon = `<svg class="w-6 h-6 inline mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = '';
}

label.innerHTML = `${icon}${file.name}${message}`;
} else {
label.innerHTML = `<svg class="w-8 h-8 mx-auto mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Upload logo for best results`;
}
}

// Upload brand
async function uploadBrand() {
const file = document.getElementById('pdfFile').files[0];
if (!file || !apiBase) return;

const logoFile = document.getElementById('logoFile').files[0];

const btn = document.getElementById('uploadBtn');
const status = document.getElementById('uploadStatus');
btn.disabled = true;
btn.textContent = 'Uploading & Processing...';
status.innerHTML = '';

try {
const formData = new FormData();
formData.append('file', file);
formData.append('organization_id', '00000000-0000-0000-0000-000000000000');
formData.append('brand_name', file.name.replace('.pdf', ''));

// Add logo if provided
if (logoFile) {
formData.append('logo', logoFile);
}

const response = await fetch(`${apiBase}/brands/ingest`, {
method: 'POST',
body: formData
});

const data = await response.json();
if (!response.ok) throw new Error(data.error?.message || 'Upload failed');

status.innerHTML = `
<div class="p-3 bg-green-50 text-green-700 rounded text-sm">
<p class="font-medium">‚úì Brand created!</p>
<p class="text-xs mt-1">ID: ${data.brand_id}</p>
${logoFile ? '<p class="text-xs text-green-600 mt-1">‚úì Logo uploaded</p>' : '<p class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è No logo uploaded</p>'}
${data.needs_review?.length > 0 ? `<p class="text-yellow-700 mt-1">‚ö†Ô∏è ${data.needs_review.join(', ')}</p>` : ''}
</div>
`;

document.getElementById('pdfFile').value = '';
document.getElementById('logoFile').value = '';
updateFileName();
updateLogoFileName();
fetchBrands();
} catch (e) {
status.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${e.message}</div>`;
}

btn.disabled = false;
btn.textContent = 'Upload & Ingest';
}

// Generate asset
async function generateAsset() {
const brandId = document.getElementById('brandSelect').value;
const prompt = document.getElementById('promptInput').value;
const asyncMode = false; // Always use sync mode for now

if (!brandId || !prompt || !apiBase) return;

const btn = document.getElementById('generateBtn');
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');

btn.disabled = true;
btn.textContent = 'Generating...';
jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<p class="text-sm text-blue-700 font-medium">‚è≥ Generating asset...</p>
<p class="text-xs text-blue-600 mt-1">This may take 2-3 minutes for compliance checking and retries</p>
</div>
`;
errorDiv.innerHTML = '';

try {
const response = await fetch(`${apiBase}/generate`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ brand_id: brandId, prompt, async_mode: asyncMode })
});

const data = await response.json();
if (!response.ok) throw new Error(data.detail || 'Generation failed');

if (asyncMode && data.job_id) {
jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<p class="text-sm text-blue-700 font-medium">Job: pending</p>
<p class="text-xs text-blue-600 mt-1 font-mono">${data.job_id}</p>
</div>
`;
pollJob(data.job_id, prompt);  // Pass the prompt to pollJob
} else {
displayAsset(data);
document.getElementById('promptInput').value = '';
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm border border-red-200">${e.message}</div>`;
}

btn.disabled = false;
btn.textContent = 'üé® Generate Asset';
}

// Poll job
async function pollJob(jobId, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');
let attempts = 0;
const maxAttempts = 120;

const poll = async () => {
try {
const response = await fetch(`${apiBase}/jobs/${jobId}`);
const job = await response.json();

console.log('Job poll response:', job);

jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<div class="flex justify-between items-center">
<p class="text-sm text-blue-700 font-medium">Job: ${job.status}</p>
${job.progress ? `<span class="text-xs text-blue-600">${job.progress}%</span>` : ''}
</div>
<p class="text-xs text-blue-600 mt-1 font-mono">${jobId}</p>
</div>
`;

if (job.status === 'completed') {
// Map job response to asset format expected by displayAsset
const asset = {
image_url: job.current_image_url,
compliance_score: job.compliance_score,
status: job.status,
prompt: originalPrompt
};
console.log('Displaying asset:', asset);
displayAsset(asset);
document.getElementById('promptInput').value = '';
jobStatusDiv.innerHTML = '';
return;
}

if (job.status === 'needs_review') {
// Show interactive review UI
showReviewUI(job, jobId, originalPrompt);
return;
}

if (job.status === 'failed') {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${job.error || 'Generation failed'}</div>`;
jobStatusDiv.innerHTML = '';
return;
}

attempts++;
if (attempts < maxAttempts) {
setTimeout(poll, 3000);
} else {
errorDiv.innerHTML = '<div class="p-3 bg-red-50 text-red-700 rounded text-sm">Job timed out</div>';
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">Polling error: ${e.message}</div>`;
}
};

poll();
}

// Display asset
function displayAsset(asset) {
console.log('displayAsset called with:', asset);

// Validate asset has image_url
if (!asset.image_url) {
console.error('Asset missing image_url:', asset);
document.getElementById('assetResult').innerHTML = `
<div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
<p class="text-yellow-800">‚ö†Ô∏è Image generation completed but image URL is missing</p>
<pre class="text-xs mt-2 bg-white p-2 rounded overflow-auto">${JSON.stringify(asset, null, 2)}</pre>
</div>
`;
return;
}

assets.unshift(asset);
document.getElementById('assetCount').textContent = assets.length;

const compliance = asset.compliance_score || asset.compliance_details?.overall_score || 0;
const violations = asset.compliance_details?.violations || [];
const categories = asset.compliance_details?.categories || {};
const badgeColor = compliance >= 80 ? 'bg-green-500' : compliance >= 60 ? 'bg-yellow-500' : 'bg-red-500';

document.getElementById('assetResult').innerHTML = `
<div>
<div class="flex justify-between items-start mb-3">
<span class="font-semibold">Result</span>
<span class="${badgeColor} text-white text-sm font-bold px-2 py-1 rounded">${Math.round(compliance)}%</span>
</div>
${asset.image_url ? `
<a href="${asset.image_url}" target="_blank">
<img src="${asset.image_url}" alt="Generated asset" class="w-full rounded-lg mb-3 border hover:opacity-90">
</a>
` : '<p class="text-red-500">No image URL</p>'}
${Object.keys(categories).length > 0 ? `
<div class="mb-3">
<p class="text-sm font-medium mb-2">Category Scores</p>
<div class="grid grid-cols-2 gap-2">
${Object.entries(categories).map(([cat, score]) => {
const catColor = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
return `
<div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
<span class="text-gray-600 capitalize">${cat.replace('_', ' ')}</span>
<span class="${catColor} text-white text-xs font-bold px-2 py-1 rounded">${Math.round(score)}%</span>
</div>
`;
}).join('')}
</div>
</div>
` : ''}
${violations.length > 0 ? `
<div class="p-3 bg-yellow-50 rounded border border-yellow-200">
<p class="text-sm font-medium text-yellow-800 mb-1">Violations (${violations.length})</p>
<ul class="text-sm text-yellow-700 space-y-1">
${violations.slice(0, 5).map(v => `<li>‚Ä¢ <span class="font-medium">${v.category}:</span> ${v.description}</li>`).join('')}
${violations.length > 5 ? `<li class="text-yellow-600">...and ${violations.length - 5} more</li>` : ''}
</ul>
</div>
` : ''}
</div>
`;

updateGallery();
}

// Update gallery
function updateGallery() {
const container = document.getElementById('galleryGrid');
if (assets.length === 0) {
container.innerHTML = `
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500 col-span-full">
<p class="text-lg mb-2">No assets generated yet</p>
<p class="text-sm">Use the Generate tab to create some!</p>
</div>
`;
return;
}

container.innerHTML = assets.map((asset, i) => {
const compliance = asset.compliance_score || asset.compliance_details?.overall_score || 0;
const badgeColor = compliance >= 80 ? 'bg-green-500' : compliance >= 60 ? 'bg-yellow-500' : 'bg-red-500';
return `
<div class="bg-white rounded-lg shadow overflow-hidden">
${asset.image_url ? `
<a href="${asset.image_url}" target="_blank">
<img src="${asset.image_url}" alt="Asset" class="w-full h-40 object-cover hover:opacity-90">
</a>
` : '<div class="w-full h-40 bg-gray-200"></div>'}
<div class="p-3">
<div class="flex justify-between items-center mb-2">
<span class="${badgeColor} text-white text-sm font-bold px-2 py-1 rounded">${Math.round(compliance)}%</span>
<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">${asset.status || 'completed'}</span>
</div>
<p class="text-xs text-gray-500 truncate" title="${asset.prompt || ''}">${asset.prompt || 'No prompt'}</p>
</div>
</div>
`;
}).join('');
}

// Show review UI for needs_review status
function showReviewUI(job, jobId, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const assetResultDiv = document.getElementById('assetResult');

const compliance = job.compliance_score || 0;
const badgeColor = compliance >= 80 ? 'bg-green-500' : compliance >= 60 ? 'bg-yellow-500' : 'bg-red-500';

// Show the image in the result area with review options
assetResultDiv.innerHTML = `
<div>
<div class="flex justify-between items-start mb-3">
<span class="font-semibold">Review Required</span>
<span class="${badgeColor} text-white text-sm font-bold px-2 py-1 rounded">${Math.round(compliance)}%</span>
</div>
${job.current_image_url ? `
<a href="${job.current_image_url}" target="_blank">
<img src="${job.current_image_url}" alt="Generated asset" class="w-full rounded-lg mb-3 border hover:opacity-90">
</a>
` : '<p class="text-red-500">No image URL</p>'}
<div class="p-4 bg-yellow-50 rounded border border-yellow-200 mb-3">
<p class="text-sm font-medium text-yellow-800 mb-2">‚ö†Ô∏è Borderline Compliance (${Math.round(compliance)}%)</p>
<p class="text-xs text-yellow-700">This image scored between 70-95%. You can approve it as-is, request tweaks, or regenerate from scratch.</p>
</div>
</div>
`;

// Show review decision UI in job status area
jobStatusDiv.innerHTML = `
<div class="p-4 bg-blue-50 rounded border border-blue-200">
<p class="text-sm font-medium text-blue-800 mb-3">Choose an action:</p>
<div class="space-y-2">
<button onclick="submitReviewDecision('${jobId}', 'approve', null, '${originalPrompt}')"
class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 font-medium">
‚úì Approve - Good Enough!
</button>
<div class="border rounded p-3 bg-white">
<label class="block text-sm text-gray-700 mb-2">‚úèÔ∏è Tweak - Custom Instructions:</label>
<textarea id="tweakInstruction" placeholder="E.g., Make the brand colors more prominent, or Fix the gold color to be brighter"
class="w-full border rounded px-3 py-2 text-sm h-20 resize-none mb-2"></textarea>
<button onclick="submitReviewDecisionWithTweak('${jobId}', '${originalPrompt}')"
class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 font-medium">
Apply Tweak
</button>
</div>
<button onclick="submitReviewDecision('${jobId}', 'regenerate', null, '${originalPrompt}')"
class="w-full bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 font-medium">
üîÑ Regenerate - Start Fresh
</button>
</div>
<p class="text-xs text-gray-500 mt-3 font-mono">Job ID: ${jobId}</p>
</div>
`;
}

// Submit review decision
async function submitReviewDecision(jobId, decision, tweakInstruction, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');

try {
jobStatusDiv.innerHTML = `<div class="p-3 bg-blue-50 rounded"><p class="text-sm text-blue-700">Submitting decision...</p></div>`;

const body = { decision };
if (decision === 'tweak' && tweakInstruction) {
body.tweak_instruction = tweakInstruction;
}

const response = await fetch(`${apiBase}/jobs/${jobId}/review`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(body)
});

const data = await response.json();
if (!response.ok) throw new Error(data.detail || data.error?.message || 'Review failed');

if (decision === 'approve') {
// Job is completed, show the approved asset
const asset = {
image_url: document.querySelector('#assetResult img')?.src,
compliance_score: document.querySelector('#assetResult .bg-green-500, #assetResult .bg-yellow-500, #assetResult .bg-red-500')?.textContent?.trim(),
status: 'completed',
prompt: originalPrompt
};
displayAsset(asset);
jobStatusDiv.innerHTML = '<div class="p-3 bg-green-50 rounded text-green-700 text-sm">‚úì Approved and completed!</div>';
setTimeout(() => { jobStatusDiv.innerHTML = ''; }, 3000);
} else {
// Job resumed with tweak or regenerate, continue polling
jobStatusDiv.innerHTML = `<div class="p-3 bg-blue-50 rounded"><p class="text-sm text-blue-700">Resuming generation...</p></div>`;
pollJob(jobId, originalPrompt);
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${e.message}</div>`;
}
}

// Submit review decision with tweak
function submitReviewDecisionWithTweak(jobId, originalPrompt) {
const tweakInstruction = document.getElementById('tweakInstruction').value.trim();
if (!tweakInstruction) {
alert('Please enter tweak instructions');
return;
}
submitReviewDecision(jobId, 'tweak', tweakInstruction, originalPrompt);
}

// Initialize
document.getElementById('apiUrl').value = 'https://rocoloco--mobius-v2-final-fastapi-app.modal.run/v1';
</script>
</body>
</html>
