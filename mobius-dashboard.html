<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobius Test Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<div id="app" class="max-w-6xl mx-auto">
<!-- Header -->
<div class="mb-6">
<h1 class="text-2xl font-bold text-gray-800">üîÑ Mobius Test Dashboard</h1>
<p class="text-gray-600">Brand Governance Engine - Testing Interface</p>
</div>

<!-- API Config -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
<h3 class="font-semibold mb-3">API Configuration</h3>
<div class="flex gap-2">
<input type="text" id="apiUrl" placeholder="https://rocoloco--mobius-v2-fastapi-app.modal.run/v1"
value="https://rocoloco--mobius-v2-fastapi-app.modal.run/v1"
class="flex-1 border rounded px-3 py-2 text-sm">
<button onclick="checkHealth()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Connect</button>
</div>
<div id="healthStatus" class="mt-2 text-sm"></div>
</div>

<!-- Tabs -->
<div class="flex gap-2 mb-4">
<button onclick="showTab('brands')" id="tab-brands" class="px-4 py-2 font-medium rounded-t-lg bg-white text-blue-600 border-b-2 border-blue-600">üìÅ Brands</button>
<button onclick="showTab('generate')" id="tab-generate" class="px-4 py-2 font-medium rounded-t-lg bg-gray-100 text-gray-600 hover:bg-gray-200">üé® Generate</button>
<button onclick="showTab('gallery')" id="tab-gallery" class="px-4 py-2 font-medium rounded-t-lg bg-gray-100 text-gray-600 hover:bg-gray-200">üñºÔ∏è Gallery (<span id="assetCount">0</span>)</button>
</div>

<!-- Tab Content -->
<div class="bg-gray-50 rounded-lg p-4">
<!-- Brands Tab -->
<div id="content-brands" class="grid md:grid-cols-2 gap-4">
<!-- Upload -->
<div class="space-y-4">
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Upload Brand Guidelines</h3>

<!-- PDF Upload -->
<div class="mb-3">
<label class="block text-sm text-gray-600 mb-1">Brand Guidelines PDF *</label>
<div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
<input type="file" id="pdfFile" accept=".pdf" class="hidden" onchange="updateFileName()">
<label for="pdfFile" class="cursor-pointer text-blue-600 hover:text-blue-800" id="fileLabel">
<svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
</svg>
Click to select PDF (max 50MB)
</label>
</div>
</div>

<!-- Logo Upload -->
<div class="mb-3">
<label class="block text-sm text-gray-600 mb-1">
Brand Logo (Optional)
<span class="text-xs text-green-600 font-medium">- SVG preferred for best quality!</span>
</label>
<div class="border-2 border-dashed border-blue-200 rounded-lg p-4 text-center bg-blue-50">
<input type="file" id="logoFile" accept=".svg,.png,.jpg,.jpeg" class="hidden" onchange="updateLogoFileName()">
<label for="logoFile" class="cursor-pointer text-blue-600 hover:text-blue-800" id="logoLabel">
<svg class="w-8 h-8 mx-auto mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
</svg>
Upload logo for best results
</label>
<p class="text-xs text-gray-500 mt-1">SVG (vector) preferred, or PNG with transparency (max 10MB)</p>
</div>
</div>

<button onclick="uploadBrand()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 disabled:opacity-50 font-medium" id="uploadBtn">Upload & Ingest</button>
<div id="uploadStatus" class="mt-3"></div>
</div>

<!-- Brand List -->
<div class="bg-white rounded-lg shadow p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="font-semibold">Brands (<span id="brandCount">0</span>)</h3>
<button onclick="fetchBrands()" class="text-blue-600 hover:text-blue-800 text-sm">‚Üª Refresh</button>
</div>
<div id="brandList" class="space-y-2 max-h-64 overflow-y-auto">
<p class="text-gray-500 text-sm">No brands yet. Upload a PDF above.</p>
</div>
</div>
</div>

<!-- Brand Details -->
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Brand Details</h3>
<div id="brandDetails" class="text-gray-500 text-center">Select a brand to view details</div>
</div>
</div>

<!-- Generate Tab -->
<div id="content-generate" class="hidden grid md:grid-cols-2 gap-4">
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Generate Asset</h3>
<div class="space-y-3">
<div>
<label class="block text-sm text-gray-600 mb-1">Brand</label>
<select id="brandSelect" class="w-full border rounded px-3 py-2">
<option value="">Select a brand...</option>
</select>
</div>
<div>
<label class="block text-sm text-gray-600 mb-1">Prompt</label>
<textarea id="promptInput" placeholder="Describe the asset you want to generate...
Example: A social media banner featuring our product with bold typography"
class="w-full border rounded px-3 py-2 h-28 resize-none"></textarea>
</div>
<button onclick="generateAsset()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 font-medium" id="generateBtn">üé® Generate Asset</button>
<div id="jobStatus"></div>
<div id="generateError"></div>
</div>
</div>

<!-- Result -->
<div class="bg-white rounded-lg shadow p-4">
<h3 class="font-semibold mb-3">Generated Asset</h3>
<div id="assetResult" class="text-gray-500 text-center">Generated assets will appear here</div>
</div>
</div>

<!-- Gallery Tab -->
<div id="content-gallery" class="hidden">
<div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500 col-span-full">
<p class="text-lg mb-2">No assets generated yet</p>
<p class="text-sm">Use the Generate tab to create some!</p>
</div>
</div>
</div>
</div>

<!-- Footer -->
<div class="mt-6 text-center text-sm text-gray-400">Mobius Brand Governance Engine ‚Ä¢ Phase 2 Testing</div>
</div>

<script>
// State
let apiBase = '';
let brands = [];
let assets = [];
let selectedBrand = null;

// Tab switching
function showTab(tab) {
['brands', 'generate', 'gallery'].forEach(t => {
document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
document.getElementById(`tab-${t}`).classList.toggle('bg-white', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('text-blue-600', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('border-b-2', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('border-blue-600', t === tab);
document.getElementById(`tab-${t}`).classList.toggle('bg-gray-100', t !== tab);
document.getElementById(`tab-${t}`).classList.toggle('text-gray-600', t !== tab);
});
}

// Health check
async function checkHealth() {
apiBase = document.getElementById('apiUrl').value.trim();
const statusDiv = document.getElementById('healthStatus');
statusDiv.innerHTML = '<span class="text-blue-600">Checking...</span>';
try {
const response = await fetch(`${apiBase}/health`);
const data = await response.json();
if (response.ok) {
statusDiv.innerHTML = '<span class="text-green-600">‚úì Connected to Mobius API</span>';
fetchBrands();
} else {
statusDiv.innerHTML = `<span class="text-red-600">‚úó ${data.detail || 'API Error'}</span>`;
}
} catch (e) {
statusDiv.innerHTML = `<span class="text-red-600">‚úó Connection failed: ${e.message}</span>`;
}
}

// Fetch brands
async function fetchBrands() {
if (!apiBase) return;
try {
const response = await fetch(`${apiBase}/brands?organization_id=00000000-0000-0000-0000-000000000000`);
const data = await response.json();
brands = data.brands || data || [];
document.getElementById('brandCount').textContent = brands.length;
renderBrandList();
updateBrandSelect();
} catch (e) {
console.error('Failed to fetch brands:', e);
}
}

// Render brand list
function renderBrandList() {
const container = document.getElementById('brandList');
if (brands.length === 0) {
container.innerHTML = '<p class="text-gray-500 text-sm">No brands yet. Upload a PDF above.</p>';
return;
}
container.innerHTML = brands.map(brand => `
<div onclick="selectBrand('${brand.brand_id}')" class="p-3 rounded cursor-pointer transition-colors ${selectedBrand?.brand_id === brand.brand_id ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50 hover:bg-gray-100'}">
<div class="flex justify-between items-start">
<div>
<p class="font-medium">${brand.name || 'Unnamed Brand'}</p>
<p class="text-xs text-gray-500 font-mono">${brand.brand_id?.slice(0, 8)}...</p>
</div>
${brand.learning_active ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Learning</span>' : ''}
</div>
</div>
`).join('');
}

// Select brand
async function selectBrand(brandId) {
try {
const response = await fetch(`${apiBase}/brands/${brandId}`);
selectedBrand = await response.json();
renderBrandList();
renderBrandDetails();
} catch (e) {
console.error('Failed to fetch brand details:', e);
}
}

// Render brand details
function renderBrandDetails() {
const container = document.getElementById('brandDetails');
if (!selectedBrand) {
container.innerHTML = '<p class="text-gray-500 text-center">Select a brand to view details</p>';
return;
}

const guidelines = selectedBrand.guidelines || {};
const colors = guidelines.colors || [];
const typography = guidelines.typography || [];
const logos = guidelines.logos || [];
const voice = guidelines.voice || null;
const rules = guidelines.rules || [];

container.innerHTML = `
<div class="space-y-4 max-h-[600px] overflow-y-auto">
${selectedBrand.logo_thumbnail_url ? `
<div class="flex justify-center p-4 bg-gray-50 rounded">
<img src="${selectedBrand.logo_thumbnail_url}" alt="${selectedBrand.name} logo" class="max-h-24 object-contain">
</div>
` : ''}

<div>
<p class="text-xs text-gray-500 uppercase tracking-wide">Name</p>
<p class="font-medium">${selectedBrand.name || 'Unnamed'}</p>
</div>

<div>
<p class="text-xs text-gray-500 uppercase tracking-wide">ID</p>
<p class="text-sm font-mono bg-gray-100 p-1 rounded">${selectedBrand.brand_id}</p>
</div>

${selectedBrand.pdf_url ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Brand Guidelines PDF</p>
<a href="${selectedBrand.pdf_url}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
View Original PDF
</a>
</div>
` : ''}

${colors.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Colors (${colors.length})</p>
<div class="space-y-2">
${colors.map(color => `
<div class="flex items-start gap-2">
<div class="w-10 h-10 rounded border shadow-sm flex-shrink-0" style="background-color: ${color.hex}" title="${color.hex}"></div>
<div class="flex-1 min-w-0">
<p class="text-sm font-medium">${color.name}</p>
<p class="text-xs text-gray-500">${color.hex} ‚Ä¢ ${color.usage}</p>
${color.context ? `<p class="text-xs text-gray-600 mt-1">${color.context}</p>` : ''}
</div>
</div>
`).join('')}
</div>
</div>
` : ''}

${typography.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Typography (${typography.length})</p>
<div class="space-y-2">
${typography.map(typo => `
<div class="bg-gray-50 p-2 rounded">
<p class="text-sm font-medium">${typo.family}</p>
<p class="text-xs text-gray-500">Weights: ${typo.weights.join(', ')}</p>
<p class="text-xs text-gray-600 mt-1">${typo.usage}</p>
</div>
`).join('')}
</div>
</div>
` : ''}

${logos.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Logo Rules (${logos.length})</p>
<div class="space-y-2">
${logos.map(logo => `
<div class="bg-gray-50 p-2 rounded">
<p class="text-sm font-medium">${logo.variant_name}</p>
<p class="text-xs text-gray-600">Min width: ${logo.min_width_px}px</p>
<p class="text-xs text-gray-600">Clear space: ${(logo.clear_space_ratio * 100).toFixed(0)}%</p>
${logo.forbidden_backgrounds.length > 0 ? `<p class="text-xs text-red-600 mt-1">Avoid: ${logo.forbidden_backgrounds.join(', ')}</p>` : ''}
</div>
`).join('')}
</div>
</div>
` : ''}

${voice ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Voice & Tone</p>
<div class="bg-gray-50 p-2 rounded space-y-2">
${voice.adjectives?.length > 0 ? `<p class="text-xs"><span class="font-medium">Adjectives:</span> ${voice.adjectives.join(', ')}</p>` : ''}
${voice.forbidden_words?.length > 0 ? `<p class="text-xs text-red-600"><span class="font-medium">Avoid:</span> ${voice.forbidden_words.join(', ')}</p>` : ''}
${voice.example_phrases?.length > 0 ? `
<div class="text-xs">
<p class="font-medium">Examples:</p>
<ul class="list-disc list-inside mt-1">
${voice.example_phrases.map(phrase => `<li>${phrase}</li>`).join('')}
</ul>
</div>
` : ''}
</div>
</div>
` : ''}

${rules.length > 0 ? `
<div>
<p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Brand Rules (${rules.length})</p>
<div class="space-y-2">
${rules.map(rule => `
<div class="bg-gray-50 p-2 rounded border-l-2 ${rule.severity === 'critical' ? 'border-red-500' : 'border-yellow-500'}">
<div class="flex items-start justify-between gap-2">
<p class="text-xs flex-1">${rule.instruction}</p>
<span class="text-xs px-1.5 py-0.5 rounded ${rule.severity === 'critical' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${rule.severity}</span>
</div>
<p class="text-xs text-gray-500 mt-1">${rule.category} ${rule.negative_constraint ? '‚Ä¢ Do Not' : ''}</p>
</div>
`).join('')}
</div>
</div>
` : ''}

${selectedBrand.needs_review?.length > 0 ? `
<div class="p-3 bg-yellow-50 rounded border border-yellow-200">
<p class="text-xs text-yellow-700 uppercase tracking-wide font-medium">Needs Review</p>
<ul class="text-sm text-yellow-800 mt-1">
${selectedBrand.needs_review.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
</ul>
</div>
` : ''}

<details class="text-sm">
<summary class="cursor-pointer text-gray-500 hover:text-gray-700">‚ñº View Raw Guidelines JSON</summary>
<pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-48">${JSON.stringify(guidelines, null, 2)}</pre>
</details>
</div>
`;
}

// Update brand select dropdown
function updateBrandSelect() {
const select = document.getElementById('brandSelect');
select.innerHTML = '<option value="">Select a brand...</option>' + 
brands.map(b => `<option value="${b.brand_id}">${b.name || b.brand_id?.slice(0, 8)}</option>`).join('');
}

// File upload helpers
function updateFileName() {
const file = document.getElementById('pdfFile').files[0];
const label = document.getElementById('fileLabel');
if (file) {
label.innerHTML = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${file.name}`;
} else {
label.innerHTML = `<svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Click to select PDF (max 50MB)`;
}
}

function updateLogoFileName() {
const file = document.getElementById('logoFile').files[0];
const label = document.getElementById('logoLabel');
if (file) {
const fileName = file.name.toLowerCase();
const isSVG = fileName.endsWith('.svg');
const isPNG = fileName.endsWith('.png');
const isJPG = fileName.endsWith('.jpg') || fileName.endsWith('.jpeg');

let icon, message;
if (isSVG) {
// SVG is best - green checkmark with star
icon = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = ' <span class="text-xs text-green-600 font-medium">‚ú® Perfect! Vector format</span>';
} else if (isPNG) {
// PNG is good - green checkmark
icon = `<svg class="w-6 h-6 inline mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = ' <span class="text-xs text-gray-500">(SVG would be even better)</span>';
} else if (isJPG) {
// JPG is okay but not ideal - yellow warning
icon = `<svg class="w-6 h-6 inline mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
message = ' <span class="text-xs text-yellow-600">(PNG or SVG preferred)</span>';
} else {
// Unknown format
icon = `<svg class="w-6 h-6 inline mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
message = '';
}

label.innerHTML = `${icon}${file.name}${message}`;
} else {
label.innerHTML = `<svg class="w-8 h-8 mx-auto mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Upload logo for best results`;
}
}

// Upload brand
async function uploadBrand() {
const file = document.getElementById('pdfFile').files[0];
if (!file || !apiBase) return;

const logoFile = document.getElementById('logoFile').files[0];

const btn = document.getElementById('uploadBtn');
const status = document.getElementById('uploadStatus');
btn.disabled = true;
btn.textContent = 'Uploading & Processing...';
status.innerHTML = '';

try {
const formData = new FormData();
formData.append('file', file);
formData.append('organization_id', '00000000-0000-0000-0000-000000000000');
formData.append('brand_name', file.name.replace('.pdf', ''));

// Add logo if provided
if (logoFile) {
formData.append('logo', logoFile);
}

const response = await fetch(`${apiBase}/brands/ingest`, {
method: 'POST',
body: formData
});

const data = await response.json();
if (!response.ok) throw new Error(data.error?.message || 'Upload failed');

status.innerHTML = `
<div class="p-3 bg-green-50 text-green-700 rounded text-sm">
<p class="font-medium">‚úì Brand created!</p>
<p class="text-xs mt-1">ID: ${data.brand_id}</p>
${logoFile ? '<p class="text-xs text-green-600 mt-1">‚úì Logo uploaded</p>' : '<p class="text-xs text-yellow-600 mt-1">‚ö†Ô∏è No logo uploaded</p>'}
${data.needs_review?.length > 0 ? `<p class="text-yellow-700 mt-1">‚ö†Ô∏è ${data.needs_review.join(', ')}</p>` : ''}
</div>
`;

document.getElementById('pdfFile').value = '';
document.getElementById('logoFile').value = '';
updateFileName();
updateLogoFileName();
fetchBrands();
} catch (e) {
status.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${e.message}</div>`;
}

btn.disabled = false;
btn.textContent = 'Upload & Ingest';
}

// Generate asset
async function generateAsset() {
const brandId = document.getElementById('brandSelect').value;
const prompt = document.getElementById('promptInput').value;
const asyncMode = false; // Always use sync mode for now

if (!brandId || !prompt || !apiBase) return;

const btn = document.getElementById('generateBtn');
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');

btn.disabled = true;
btn.textContent = 'Generating...';
jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<p class="text-sm text-blue-700 font-medium">‚è≥ Generating asset...</p>
<p class="text-xs text-blue-600 mt-1">This may take 2-3 minutes for compliance checking and retries</p>
</div>
`;
errorDiv.innerHTML = '';

try {
const response = await fetch(`${apiBase}/generate`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ brand_id: brandId, prompt, async_mode: asyncMode })
});

const data = await response.json();
if (!response.ok) throw new Error(data.detail || 'Generation failed');

if (asyncMode && data.job_id) {
jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<p class="text-sm text-blue-700 font-medium">Job: pending</p>
<p class="text-xs text-blue-600 mt-1 font-mono">${data.job_id}</p>
</div>
`;
pollJob(data.job_id, prompt);  // Pass the prompt to pollJob
} else {
// Add job_id to sync response
data.job_id = data.job_id || 'unknown';
data.prompt = prompt;
displayAsset(data);
document.getElementById('promptInput').value = '';
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm border border-red-200">${e.message}</div>`;
}

btn.disabled = false;
btn.textContent = 'üé® Generate Asset';
}

// Poll job
async function pollJob(jobId, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');
let attempts = 0;
const maxAttempts = 120;

const poll = async () => {
try {
const response = await fetch(`${apiBase}/jobs/${jobId}`);
const job = await response.json();

console.log('Job poll response:', job);

jobStatusDiv.innerHTML = `
<div class="p-3 bg-blue-50 rounded border border-blue-200">
<div class="flex justify-between items-center">
<p class="text-sm text-blue-700 font-medium">Job: ${job.status}</p>
${job.progress ? `<span class="text-xs text-blue-600">${job.progress}%</span>` : ''}
</div>
<p class="text-xs text-blue-600 mt-1 font-mono">${jobId}</p>
</div>
`;

if (job.status === 'completed') {
// Map job response to asset format expected by displayAsset
const asset = {
image_url: job.current_image_url,
compliance_score: job.compliance_score,
status: job.status,
prompt: originalPrompt,
job_id: jobId  // Pass job_id for tweaking
};
console.log('Displaying asset:', asset);
displayAsset(asset);
document.getElementById('promptInput').value = '';
jobStatusDiv.innerHTML = '';
return;
}

if (job.status === 'needs_review') {
// Show interactive review UI
showReviewUI(job, jobId, originalPrompt);
return;
}

if (job.status === 'failed') {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${job.error || 'Generation failed'}</div>`;
jobStatusDiv.innerHTML = '';
return;
}

attempts++;
if (attempts < maxAttempts) {
setTimeout(poll, 3000);
} else {
errorDiv.innerHTML = '<div class="p-3 bg-red-50 text-red-700 rounded text-sm">Job timed out</div>';
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">Polling error: ${e.message}</div>`;
}
};

poll();
}

// Display asset
function displayAsset(asset) {
console.log('displayAsset called with:', asset);

// Validate asset has image_url
if (!asset.image_url) {
console.error('Asset missing image_url:', asset);
document.getElementById('assetResult').innerHTML = `
<div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
<p class="text-yellow-800">‚ö†Ô∏è Image generation completed but image URL is missing</p>
<pre class="text-xs mt-2 bg-white p-2 rounded overflow-auto">${JSON.stringify(asset, null, 2)}</pre>
</div>
`;
return;
}

// Store current job_id for tweaking
window.currentJobId = asset.job_id;
window.currentPrompt = asset.prompt;

assets.unshift(asset);
document.getElementById('assetCount').textContent = assets.length;

// Extract compliance data from various possible locations
const complianceScore = asset.compliance_score?.overall_score || asset.compliance_score || 0;
const complianceData = asset.compliance_score || {};
const categories = complianceData.categories || [];
const summary = complianceData.summary || '';
const approved = complianceData.approved !== undefined ? complianceData.approved : (complianceScore >= 80);

const badgeColor = complianceScore >= 95 ? 'bg-green-500' : complianceScore >= 80 ? 'bg-blue-500' : complianceScore >= 60 ? 'bg-yellow-500' : 'bg-red-500';
const statusText = approved ? '‚úì Auto-Approved' : '‚ö† Needs Review';
const statusColor = approved ? 'text-green-700' : 'text-yellow-700';

// Build category scores HTML
let categoriesHTML = '';
if (categories.length > 0) {
categoriesHTML = `
<div class="mb-4">
<p class="text-sm font-semibold text-gray-700 mb-2">Category Breakdown</p>
<div class="space-y-2">
${categories.map(cat => {
const catScore = cat.score || 0;
const catColor = catScore >= 80 ? 'bg-green-500' : catScore >= 60 ? 'bg-yellow-500' : 'bg-red-500';
const catPassed = cat.passed ? '‚úì' : '‚úó';
const violations = cat.violations || [];
return `
<div class="bg-gray-50 rounded-lg p-3 border ${cat.passed ? 'border-gray-200' : 'border-yellow-300'}">
<div class="flex justify-between items-center mb-1">
<span class="text-sm font-medium capitalize">${cat.category.replace('_', ' ')}</span>
<div class="flex items-center gap-2">
<span class="text-xs ${cat.passed ? 'text-green-600' : 'text-yellow-600'}">${catPassed}</span>
<span class="${catColor} text-white text-xs font-bold px-2 py-1 rounded">${Math.round(catScore)}%</span>
</div>
</div>
${violations.length > 0 ? `
<div class="mt-2 space-y-1">
${violations.map(v => `
<div class="text-xs bg-white rounded p-2 border border-gray-200">
<div class="flex items-start gap-1">
<span class="text-${v.severity === 'critical' ? 'red' : v.severity === 'medium' ? 'yellow' : 'blue'}-500 font-bold">‚ñ∏</span>
<div class="flex-1">
<p class="text-gray-700">${v.description}</p>
${v.fix_suggestion ? `<p class="text-gray-500 italic mt-1">üí° ${v.fix_suggestion}</p>` : ''}
</div>
</div>
</div>
`).join('')}
</div>
` : ''}
</div>
`;
}).join('')}
</div>
</div>
`;
}

document.getElementById('assetResult').innerHTML = `
<div>
<!-- Header -->
<div class="flex justify-between items-start mb-3">
<div>
<span class="font-semibold text-lg">Generated Asset</span>
<p class="text-xs ${statusColor} font-medium mt-1">${statusText}</p>
</div>
<span class="${badgeColor} text-white text-sm font-bold px-3 py-1.5 rounded-full shadow">${Math.round(complianceScore)}%</span>
</div>

<!-- Image -->
${asset.image_url ? `
<a href="${asset.image_url}" target="_blank" class="block mb-4">
<img src="${asset.image_url}" alt="Generated asset" class="w-full rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-colors shadow-sm">
<p class="text-xs text-gray-500 text-center mt-1">Click to view full size</p>
</a>
` : '<p class="text-red-500">No image URL</p>'}

<!-- Summary -->
${summary ? `
<div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
<p class="text-xs font-semibold text-blue-900 mb-1">Compliance Summary</p>
<p class="text-sm text-blue-800">${summary}</p>
</div>
` : ''}

<!-- Categories -->
${categoriesHTML}

<!-- Action Buttons -->
<div class="grid grid-cols-2 gap-2">
<a href="${asset.image_url}" download class="bg-blue-500 text-white text-center py-2 rounded-lg hover:bg-blue-600 font-medium transition-colors flex items-center justify-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
</svg>
Download
</a>
<button onclick="showTweakUI('${asset.job_id || ''}')" class="bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 font-medium transition-colors flex items-center justify-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
</svg>
Tweak
</button>
</div>

<!-- Tweak UI (hidden by default) -->
<div id="tweakUI" class="hidden mt-4 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
<p class="text-sm font-semibold text-purple-900 mb-2">‚ú® Refine This Image</p>
<p class="text-xs text-purple-700 mb-3">Tell the AI what to adjust while keeping the rest of the image</p>
<textarea id="tweakInstructionInput" placeholder="Example: 'Make the logo larger and more prominent' or 'Adjust the gold color to be more vibrant'"
class="w-full border-2 border-purple-200 rounded-md px-3 py-2 text-sm h-24 resize-none mb-2 focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-200"></textarea>
<div class="flex gap-2">
<button id="tweakSubmitBtn" onclick="submitTweak()" class="flex-1 bg-purple-500 text-white py-2 rounded-md hover:bg-purple-600 font-medium transition-colors disabled:bg-purple-300 disabled:cursor-not-allowed">
Apply Tweak
</button>
<button onclick="hideTweakUI()" class="px-4 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400 font-medium transition-colors">
Cancel
</button>
</div>
<div id="tweakStatus" class="mt-2"></div>
</div>
</div>
`;

updateGallery();
}

// Update gallery
function updateGallery() {
const container = document.getElementById('galleryGrid');
if (assets.length === 0) {
container.innerHTML = `
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500 col-span-full">
<p class="text-lg mb-2">No assets generated yet</p>
<p class="text-sm">Use the Generate tab to create some!</p>
</div>
`;
return;
}

container.innerHTML = assets.map((asset, i) => {
const compliance = asset.compliance_score || asset.compliance_details?.overall_score || 0;
const badgeColor = compliance >= 80 ? 'bg-green-500' : compliance >= 60 ? 'bg-yellow-500' : 'bg-red-500';
return `
<div class="bg-white rounded-lg shadow overflow-hidden">
${asset.image_url ? `
<a href="${asset.image_url}" target="_blank">
<img src="${asset.image_url}" alt="Asset" class="w-full h-40 object-cover hover:opacity-90">
</a>
` : '<div class="w-full h-40 bg-gray-200"></div>'}
<div class="p-3">
<div class="flex justify-between items-center mb-2">
<span class="${badgeColor} text-white text-sm font-bold px-2 py-1 rounded">${Math.round(compliance)}%</span>
<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">${asset.status || 'completed'}</span>
</div>
<p class="text-xs text-gray-500 truncate" title="${asset.prompt || ''}">${asset.prompt || 'No prompt'}</p>
</div>
</div>
`;
}).join('');
}

// Show review UI for needs_review status
function showReviewUI(job, jobId, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const assetResultDiv = document.getElementById('assetResult');

// Extract compliance data from job state
const complianceScores = job.state?.compliance_scores || [];
const latestCompliance = complianceScores[complianceScores.length - 1] || {};
const compliance = latestCompliance.overall_score || job.compliance_score || 0;
const categories = latestCompliance.categories || [];
const summary = latestCompliance.summary || '';

const badgeColor = compliance >= 80 ? 'bg-green-500' : compliance >= 60 ? 'bg-yellow-500' : 'bg-red-500';

// Extract all violations from categories
let allViolations = [];
categories.forEach(cat => {
if (cat.violations && cat.violations.length > 0) {
cat.violations.forEach(v => {
allViolations.push({
category: cat.category,
description: v.description,
severity: v.severity,
fix_suggestion: v.fix_suggestion
});
});
}
});

// Build violations HTML if available
let violationsHTML = '';
if (allViolations.length > 0) {
violationsHTML = `
<div class="p-4 bg-orange-50 rounded border-2 border-orange-200 mb-4">
<div class="flex items-start gap-2 mb-3">
<svg class="w-5 h-5 text-orange-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div class="flex-1">
<p class="text-sm font-semibold text-orange-900 mb-1">Brand Compliance Issues (${allViolations.length})</p>
<p class="text-xs text-orange-700">Review these issues and decide how to proceed:</p>
</div>
</div>
<ul class="text-xs text-orange-800 space-y-2.5 ml-1">
${allViolations.map(v => `
<li class="flex items-start gap-2 bg-white rounded p-2 border border-orange-100">
<span class="text-orange-500 font-bold mt-0.5 flex-shrink-0">‚ñ∏</span>
<div class="flex-1">
<div class="font-semibold capitalize text-orange-900">${v.category}</div>
<div class="text-orange-700 mt-0.5">${v.description}</div>
${v.fix_suggestion ? `<div class="text-orange-600 italic mt-1.5 text-xs bg-orange-50 p-1.5 rounded border border-orange-100">üí° ${v.fix_suggestion}</div>` : ''}
</div>
</li>
`).join('')}
</ul>
</div>
`;
}

// Show the image in the result area with review options
assetResultDiv.innerHTML = `
<div>
<!-- Header with attention-grabbing banner -->
<div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg mb-4 shadow-md">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center gap-2">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
</svg>
<span class="font-bold text-lg">Your Review Needed</span>
</div>
<span class="${badgeColor} text-white text-sm font-bold px-3 py-1.5 rounded-full shadow">${Math.round(compliance)}% Compliant</span>
</div>
<p class="text-sm text-blue-50">This image scored <strong>${Math.round(compliance)}%</strong> (between 70-95%). Please review and choose how to proceed.</p>
</div>

<!-- Compliance Summary -->
${summary ? `
<div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
<p class="text-xs font-semibold text-blue-900 mb-1">Compliance Summary</p>
<p class="text-sm text-blue-800">${summary}</p>
</div>
` : ''}

<!-- Generated Image Preview -->
<div class="mb-4">
<p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Generated Image Preview</p>
${job.current_image_url ? `
<a href="${job.current_image_url}" target="_blank" class="block">
<img src="${job.current_image_url}" alt="Generated asset" class="w-full rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-colors shadow-sm hover:shadow-md">
<p class="text-xs text-gray-500 text-center mt-1">Click to view full size</p>
</a>
` : '<p class="text-red-500 text-sm">‚ö†Ô∏è No image URL available</p>'}
</div>

${violationsHTML}
</div>
`;

// Show review decision UI in job status area with clear action cards
jobStatusDiv.innerHTML = `
<div class="bg-white rounded-lg border-2 border-blue-200 shadow-sm">
<div class="bg-blue-50 p-4 border-b-2 border-blue-200">
<p class="text-sm font-bold text-blue-900 mb-1">What would you like to do?</p>
<p class="text-xs text-blue-700">Choose an action below to continue</p>
</div>

<div class="p-4 space-y-3">
<!-- Option 1: Approve -->
<div class="bg-green-50 border-2 border-green-200 rounded-lg p-3 hover:border-green-400 transition-colors">
<button onclick="submitReviewDecision('${jobId}', 'approve', null, '${originalPrompt}')"
class="w-full bg-green-500 text-white py-2.5 px-4 rounded-md hover:bg-green-600 font-semibold shadow-sm hover:shadow transition-all flex items-center justify-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
</svg>
Approve & Use This Image
</button>
<p class="text-xs text-green-700 mt-2 text-center">The image looks good enough despite minor compliance issues</p>
</div>

<!-- Option 2: Tweak -->
<div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
<div class="flex items-start gap-2 mb-2">
<svg class="w-4 h-4 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
</svg>
<div class="flex-1">
<p class="text-sm font-semibold text-blue-900">Make a Small Adjustment</p>
<p class="text-xs text-blue-700">Tell the AI what to fix while keeping the rest of the image</p>
</div>
</div>
<textarea id="tweakInstruction" placeholder="Example: 'Make the logo pop more against the background' or 'Fix the gold color to match brand guidelines exactly'"
class="w-full border-2 border-blue-200 rounded-md px-3 py-2 text-sm h-24 resize-none mb-2 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-200"></textarea>
<button onclick="submitReviewDecisionWithTweak('${jobId}', '${originalPrompt}')"
class="w-full bg-blue-500 text-white py-2.5 px-4 rounded-md hover:bg-blue-600 font-semibold shadow-sm hover:shadow transition-all flex items-center justify-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
</svg>
Apply Custom Tweak
</button>
<p class="text-xs text-blue-600 mt-2">The AI will refine the current image based on your instructions</p>
</div>

<!-- Option 3: Regenerate -->
<div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-3 hover:border-gray-400 transition-colors">
<button onclick="submitReviewDecision('${jobId}', 'regenerate', null, '${originalPrompt}')"
class="w-full bg-gray-600 text-white py-2.5 px-4 rounded-md hover:bg-gray-700 font-semibold shadow-sm hover:shadow transition-all flex items-center justify-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
</svg>
Start Over Completely
</button>
<p class="text-xs text-gray-600 mt-2 text-center">Generate a completely new image from scratch</p>
</div>
</div>

<div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between">
<p class="text-xs text-gray-500">Job ID: <span class="font-mono">${jobId.slice(0, 8)}...</span></p>
<p class="text-xs text-gray-500">${Math.round(compliance)}% compliant</p>
</div>
</div>
`;
}

// Submit review decision
async function submitReviewDecision(jobId, decision, tweakInstruction, originalPrompt) {
const jobStatusDiv = document.getElementById('jobStatus');
const errorDiv = document.getElementById('generateError');

try {
jobStatusDiv.innerHTML = `<div class="p-3 bg-blue-50 rounded"><p class="text-sm text-blue-700">Submitting decision...</p></div>`;

const body = { decision };
if (decision === 'tweak' && tweakInstruction) {
body.tweak_instruction = tweakInstruction;
}

const response = await fetch(`${apiBase}/jobs/${jobId}/review`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(body)
});

const data = await response.json();
if (!response.ok) throw new Error(data.detail || data.error?.message || 'Review failed');

if (decision === 'approve') {
// Job is completed, show the approved asset
const asset = {
image_url: document.querySelector('#assetResult img')?.src,
compliance_score: document.querySelector('#assetResult .bg-green-500, #assetResult .bg-yellow-500, #assetResult .bg-red-500')?.textContent?.trim(),
status: 'completed',
prompt: originalPrompt
};
displayAsset(asset);
jobStatusDiv.innerHTML = '<div class="p-3 bg-green-50 rounded text-green-700 text-sm">‚úì Approved and completed!</div>';
setTimeout(() => { jobStatusDiv.innerHTML = ''; }, 3000);
} else {
// Job resumed with tweak or regenerate, continue polling
jobStatusDiv.innerHTML = `<div class="p-3 bg-blue-50 rounded"><p class="text-sm text-blue-700">Resuming generation...</p></div>`;
pollJob(jobId, originalPrompt);
}
} catch (e) {
errorDiv.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded text-sm">${e.message}</div>`;
}
}

// Submit review decision with tweak
function submitReviewDecisionWithTweak(jobId, originalPrompt) {
const tweakInstruction = document.getElementById('tweakInstruction').value.trim();
if (!tweakInstruction) {
alert('Please enter tweak instructions');
return;
}
submitReviewDecision(jobId, 'tweak', tweakInstruction, originalPrompt);
}

// Show tweak UI
function showTweakUI(jobId) {
if (!jobId && !window.currentJobId) {
alert('No job ID available for tweaking');
return;
}
const tweakUI = document.getElementById('tweakUI');
tweakUI.classList.remove('hidden');
document.getElementById('tweakInstructionInput').focus();
}

// Hide tweak UI
function hideTweakUI() {
const tweakUI = document.getElementById('tweakUI');
tweakUI.classList.add('hidden');
document.getElementById('tweakInstructionInput').value = '';
document.getElementById('tweakStatus').innerHTML = '';
}

// Submit tweak
async function submitTweak() {
const jobId = window.currentJobId;
const tweakInstruction = document.getElementById('tweakInstructionInput').value.trim();
const statusDiv = document.getElementById('tweakStatus');
const submitBtn = document.getElementById('tweakSubmitBtn');

if (!jobId) {
statusDiv.innerHTML = '<p class="text-red-600 text-sm">No job ID available</p>';
return;
}

if (!tweakInstruction) {
statusDiv.innerHTML = '<p class="text-red-600 text-sm">Please enter tweak instructions</p>';
return;
}

// Disable button to prevent duplicate requests
if (submitBtn) {
submitBtn.disabled = true;
submitBtn.textContent = 'Applying...';
}

try {
statusDiv.innerHTML = '<p class="text-blue-600 text-sm">Applying tweak...</p>';

const response = await fetch(`${apiBase}/jobs/${jobId}/tweak`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
job_id: jobId,
tweak_instruction: tweakInstruction
})
});

const data = await response.json();
if (!response.ok) throw new Error(data.error?.message || data.detail || 'Tweak failed');

statusDiv.innerHTML = '<p class="text-green-600 text-sm">‚úì Tweak submitted! Generating refined image...</p>';

// Hide tweak UI and start polling
setTimeout(() => {
hideTweakUI();
document.getElementById('jobStatus').innerHTML = `
<div class="p-3 bg-purple-50 rounded border border-purple-200">
<p class="text-sm text-purple-700 font-medium">üé® Refining image with your tweak...</p>
<p class="text-xs text-purple-600 mt-1">This may take 1-2 minutes</p>
</div>
`;
pollJob(jobId, window.currentPrompt);
}, 1000);

} catch (e) {
statusDiv.innerHTML = `<p class="text-red-600 text-sm">${e.message}</p>`;
// Re-enable button on error
if (submitBtn) {
submitBtn.disabled = false;
submitBtn.textContent = 'Apply Tweak';
}
}
}

// Initialize
document.getElementById('apiUrl').value = 'https://rocoloco--mobius-v2-final-fastapi-app.modal.run/v1';
</script>
</body>
</html>
